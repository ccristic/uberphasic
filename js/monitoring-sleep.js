var data = [
{"start":"2017-05-31 00:00:00","stop":"2017-05-31 00:00:00"},

{"start":"2017-06-01 01:00:00","stop":"2017-06-01 01:15:00"},
{"start":"2017-06-01 04:00:00","stop":"2017-06-01 04:25:00"},
{"start":"2017-06-01 11:45:00","stop":"2017-06-01 14:15:00"},
{"start":"2017-06-01 18:00:00","stop":"2017-06-01 18:45:00"},
{"start":"2017-06-01 20:30:00","stop":"2017-06-01 23:55:00"},

{"start":"2017-06-02 01:00:00","stop":"2017-06-02 01:15:00"},
{"start":"2017-06-02 04:05:00","stop":"2017-06-02 04:25:00"},
{"start":"2017-06-02 11:45:00","stop":"2017-06-02 14:15:00"},
{"start":"2017-06-02 21:00:00","stop":"2017-06-02 23:55:00"},

{"start":"2017-06-03 01:00:00","stop":"2017-06-03 01:15:00"},
{"start":"2017-06-03 03:00:00","stop":"2017-06-03 03:25:00"},
{"start":"2017-06-03 11:25:00","stop":"2017-06-03 15:15:00"},
{"start":"2017-06-03 18:15:00","stop":"2017-06-03 18:25:00"},
{"start":"2017-06-03 21:30:00","stop":"2017-06-03 22:55:00"},

{"start":"2017-06-04 01:00:00","stop":"2017-06-04 01:15:00"},
{"start":"2017-06-04 04:10:00","stop":"2017-06-04 04:25:00"},
{"start":"2017-06-04 07:40:00","stop":"2017-06-04 08:25:00"},
{"start":"2017-06-04 18:00:00","stop":"2017-06-04 18:45:00"},
{"start":"2017-06-04 21:35:00","stop":"2017-06-04 23:55:00"},

{"start":"2017-06-05 01:00:00","stop":"2017-06-05 01:15:00"},
{"start":"2017-06-05 04:15:00","stop":"2017-06-05 04:25:00"},
{"start":"2017-06-05 12:45:00","stop":"2017-06-05 14:15:00"},
{"start":"2017-06-05 18:00:00","stop":"2017-06-05 18:45:00"},
{"start":"2017-06-05 21:30:00","stop":"2017-06-05 23:45:00"},

{"start":"2017-06-06 01:00:00","stop":"2017-06-06 01:15:00"},
{"start":"2017-06-06 04:00:00","stop":"2017-06-06 04:25:00"},
{"start":"2017-06-06 13:45:00","stop":"2017-06-06 14:25:00"},
{"start":"2017-06-06 18:00:00","stop":"2017-06-06 18:45:00"},
{"start":"2017-06-06 21:30:00","stop":"2017-06-06 22:55:00"},

{"start":"2017-06-07 04:00:00","stop":"2017-06-07 04:25:00"},
{"start":"2017-06-07 11:45:00","stop":"2017-06-07 14:15:00"},
{"start":"2017-06-07 21:30:00","stop":"2017-06-07 22:55:00"},

{"start":"2017-06-08 01:00:00","stop":"2017-06-08 01:15:00"},
{"start":"2017-06-08 04:00:00","stop":"2017-06-08 04:25:00"},
{"start":"2017-06-08 11:45:00","stop":"2017-06-08 15:15:00"},
{"start":"2017-06-08 18:00:00","stop":"2017-06-08 18:45:00"},

{"start":"2017-06-09 01:00:00","stop":"2017-06-09 01:15:00"},
{"start":"2017-06-09 04:05:00","stop":"2017-06-09 04:25:00"},
{"start":"2017-06-09 11:45:00","stop":"2017-06-09 14:55:00"},
{"start":"2017-06-09 17:00:00","stop":"2017-06-09 18:45:00"},
{"start":"2017-06-09 21:30:00","stop":"2017-06-09 23:55:00"},

{"start":"2017-06-10 01:00:00","stop":"2017-06-10 01:25:00"},
{"start":"2017-06-10 04:00:00","stop":"2017-06-10 04:25:00"},
{"start":"2017-06-10 18:00:00","stop":"2017-06-10 18:40:00"},
{"start":"2017-06-10 21:30:00","stop":"2017-06-10 23:55:00"},

{"start":"2017-06-11 01:00:00","stop":"2017-06-11 01:15:00"},
{"start":"2017-06-11 04:00:00","stop":"2017-06-11 04:25:00"},
{"start":"2017-06-11 10:45:00","stop":"2017-06-11 14:15:00"},
{"start":"2017-06-11 18:20:00","stop":"2017-06-11 18:45:00"},
{"start":"2017-06-11 22:30:00","stop":"2017-06-11 22:55:00"},

{"start":"2017-06-12 01:00:00","stop":"2017-06-12 01:20:00"},
{"start":"2017-06-12 03:40:00","stop":"2017-06-12 04:25:00"},
{"start":"2017-06-12 11:45:00","stop":"2017-06-12 14:15:00"},
{"start":"2017-06-12 21:30:00","stop":"2017-06-12 23:55:00"},

{"start":"2017-06-13 01:00:00","stop":"2017-06-13 01:20:00"},
{"start":"2017-06-13 04:00:00","stop":"2017-06-13 04:25:00"},
{"start":"2017-06-13 11:45:00","stop":"2017-06-13 14:15:00"},
{"start":"2017-06-13 18:10:00","stop":"2017-06-13 18:25:00"},

{"start":"2017-06-14 04:00:00","stop":"2017-06-14 04:25:00"},
{"start":"2017-06-14 11:45:00","stop":"2017-06-14 14:55:00"},
{"start":"2017-06-14 18:00:00","stop":"2017-06-14 18:55:00"},
{"start":"2017-06-14 21:10:00","stop":"2017-06-14 23:55:00"},

{"start":"2017-06-15 01:00:00","stop":"2017-06-15 01:20:00"},
{"start":"2017-06-15 04:00:00","stop":"2017-06-15 04:25:00"},
{"start":"2017-06-15 07:00:00","stop":"2017-06-15 10:25:00"},
{"start":"2017-06-15 11:25:00","stop":"2017-06-15 13:15:00"},
{"start":"2017-06-15 18:00:00","stop":"2017-06-15 18:45:00"},
{"start":"2017-06-15 22:30:00","stop":"2017-06-15 23:55:00"},

{"start":"2017-06-16 01:00:00","stop":"2017-06-16 01:35:00"},
{"start":"2017-06-16 04:00:00","stop":"2017-06-16 04:25:00"},
{"start":"2017-06-16 12:45:00","stop":"2017-06-16 14:15:00"},
{"start":"2017-06-16 17:00:00","stop":"2017-06-16 18:45:00"},
{"start":"2017-06-16 21:30:00","stop":"2017-06-16 23:55:00"},

{"start":"2017-06-17 01:00:00","stop":"2017-06-17 01:25:00"},
{"start":"2017-06-17 04:00:00","stop":"2017-06-17 04:25:00"},
{"start":"2017-06-17 11:45:00","stop":"2017-06-17 14:15:00"},
{"start":"2017-06-17 18:00:00","stop":"2017-06-17 18:45:00"},
{"start":"2017-06-17 21:30:00","stop":"2017-06-17 23:55:00"}
];

var mySchedule = [
{"start":"01:10:00","stop":"01:40:00"},
{"start":"12:00:00","stop":"14:20:00"},
{"start":"04:00:00","stop":"04:50:00"},
{"start":"21:00:00","stop":"23:20:00"}
];
var first = d3.time.day.floor( new Date(data[0].start)),
last = d3.time.day.ceil( new Date(data[data.length-1].stop)),
dRange = [d3.min(data,function(d){
	return d3.time.day.floor(new Date(d.start))}), 
d3.max(data,function(d){
	return d3.time.day.ceil(new Date(d.stop))})];

var m = {top: 40, right: 20, bottom: 20, left: 60},
width = window.innerWidth*.7,
barSize = 12,
height = ((dRange[1]-dRange[0])/(24*60*60*1000))* barSize + 150;

var day = d3.time.format("%w"),
week = d3.time.format("%U"),
hour = d3.time.format("%X"),
format = d3.time.format("%Y-%m-%d %X"),
now = new Date();

var tip = d3.tip()
.attr('class', 'd3-tip')
.offset([-10, 0])
.html(function(d) {
	return "<strong>Start:</strong> <span style='color:#7a7cc7'>" + moment(d.start).format("MM/DD hh:mm") + " </span> <strong>End: </strong><span style='color:#7a7cc7'>" + moment(d.stop).format("MM/DD hh:mm") + "</span>";
})

var x = d3.time.scale()		
.domain([0,24])
.range([0, width]);

var y =d3.time.scale()
.domain(dRange)
.range([0, height]);

var ganttSvg;

function viewBars (data) {
	ganttSvg = d3.select(".wrapper")
	.append("div")
	.attr("class","d3-container container")
	.selectAll("svg").data(d3.range(1))
	.enter().append("svg")
	.attr("id","viz")
	.attr("width",width + m.right +m.left)
	.attr("height",height + m.top + m.bottom)
	.append("g")
	.attr('transform', 'translate(' + m.left + ', ' + m.top + ')');
	ganttSvg.call(tip);
	/* set up scales */

	var tfh = d3.time.scale()	//TwentyFourHour scale
	.domain([d3.time.hour(new Date(2017,0,1,0,0,0)),
		d3.time.hour(new Date(2017,0,2,0,0,0)),])
	.range([0,width]);

	/* add bars to chart */

	addDefaultValues();
	for (var i = 0; i < data.length; i++) {
		addTask(data[i]);
	}
	
	/*add axes and grid*/

	var xAxis = d3.svg.axis()
	.scale(tfh)
	.tickFormat(d3.time.format("%H:%M"));
	var xGrid = d3.svg.axis()
	.scale(tfh)
	.orient("bottom")
	.ticks(12);
	var yAxis = d3.svg.axis()
	.scale(y)
	.tickFormat(d3.time.format("%m/%d"));

	ganttSvg.append("g")
	.attr("class", "x top axis")
	.call(xAxis.orient("top"));	
	ganttSvg.append("g")
	.attr("class","x grid")
	.call(xGrid
		.tickSize(height, 0, 0)
		.tickFormat(""));
	ganttSvg.append("g")
	.attr("class","y left axis")
	.attr("class","axis-gantt")
	.attr('transform', 'translate(0,6)')
	.call(yAxis.orient("left"));
};

viewBars(data);

function addTask(task) {
	hour = d3.time.format("%X"),
	ganttSvg.append("g")
	.attr("class","chart")
	.selectAll("rect")
	.data([task])
	.enter()
	.append("rect")
	.attr("class",function(d){
		var c = moment(d.stop).diff(d.start, 'minutes');
		if(c <= 60)
			return("bar nap");
		else
			return("bar core");
	})

	.attr("x",function(d){
		var h = hour(new Date(d.start)).split(":"), //changes datum from string, to proper Date Object, back to hour string and splits
		xh = parseFloat(h[0])+parseFloat(h[1]/60); //time (hour and minute) as decimal
		return x(xh);a
	})
	.attr("y",function(d) { 
		return y(d3.time.day.floor(new Date(d.start)))
	})

	.attr("width",function(d){
		var hstart = new Date(d.start),
		hstop = new Date(d.stop);
		return x((hstop-hstart)/3600000);	//date operations return a timestamp in miliseconds, divide to convert to hours
	})

	.attr("height",12)
	.attr("rx",7)
	.attr("ry",15)
	.on('mouseover', tip.show)
	.on('mouseout', tip.hide)
	.datum(function(d){return Date.parse(d)});

	d3.selectAll('rect').transition()
	.duration(2000)
};

function addDefaultTask(task) {
	hour = d3.time.format("%X"),
	ganttSvg.append("g")
	.attr("class","chart")
	.selectAll("rect")
	.data([task])
	.enter()
	.append("rect")
	.attr("class",function(d){
		var c = moment(d.stop).diff(d.start, 'minutes');
		if(c <= 60)
			return("bar nap default_bar");
		else
			return("bar core default_bar");
	})

	.attr("x",function(d){
		var h = hour(new Date(d.start)).split(":"), //changes datum from string, to proper Date Object, back to hour string and splits
		xh = parseFloat(h[0])+parseFloat(h[1]/60); //time (hour and minute) as decimal
		return x(xh);a
	})
	.attr("y",function(d) { 
		return y(d3.time.day.floor(new Date(d.start)))
	})
	.attr("width",function(d){
		var hstart = new Date(d.start),
		hstop = new Date(d.stop);
		return x((hstop-hstart)/3600000);	//date operations return a timestamp in miliseconds, divide to convert to hours
	})
	.attr("height",12)
	.attr("rx",0)
	.attr("ry",0)
	.text(function(d){return(d.start)+' - '+(d.stop);})
	.datum(function(d){return Date.parse(d)})
	;
};

function addDefaultValues() {
	var interval;

	for(var p = moment(first).add(1,'days').format("YYYY-MM-DD"); p < moment(last).format("YYYY-MM-DD"); p = moment(p).add(1, 'days').format("YYYY-MM-DD"))
	{
		for(var y = 0; y < mySchedule.length; y++)
		{	

			interval = {start: moment(p).format("YYYY-MM-DD") + ' ' + mySchedule[y].start, stop: moment(p).format("YYYY-MM-DD") + ' ' + mySchedule[y].stop};
			addDefaultTask(interval);
		}
	}
};

function addTaskFromUI(nap) {
	data.push(nap);
	addTask(data[data.length-1]);
};

flatpickr('.flatpickr-data', {
	defaultDate: moment().format("YYYY-MM-DD")
});

flatpickr('.flatpickr-ora', {
	enableTime: true,
	noCalendar: true,
	time_24hr: true,
	dateFormat: "H:i",
	defaultDate: "0:00", 
	defaultHour: 0,
	defaultMinute: 0
});

function takeNapValuesFromInputs() {
	var day = document.getElementById('calendar').value;
	var start_hour = document.getElementById('start-nap').value;
	var stop_hour = document.getElementById('stop-nap').value;
	var nap = {start: day + ' ' + start_hour + ':00', stop: day + ' ' + stop_hour + ':00'};
	addTaskFromUI(nap);
};